# 完整工作流程

本文档描述 Spider Silkome 项目的完整 Spidroin 注释流程。

## 流程概览

```
第一步: Miniprot 初步注释 (已实现)
    ↓
人工修正 GFF 文件
    ↓
    ├─→ 第二步A: 整合三代 DRS 转录组数据 → 精细化基因位置
    └─→ 第二步B: 整合高质量基因组注释信息 → 完善基因位置
         ↓
    第三步: 汇总多源数据 → 充分的 Spidroin 注释
         ↓
    第四步: k-mer 特征提取 → 全基因组扫描 → 识别不完整基因
```

## 第一步：Miniprot 初步注释（已实现）

### 目标
使用 Miniprot 将已知 Spidroin 蛋白序列比对到蜘蛛基因组，生成初步的基因位置预测。

### 子步骤

1. **序列去冗余（MMseqs2 聚类）**
   - 使用 MMseqs2 对已知的 Spidroin 蛋白序列进行聚类
   - 去除高度相似的冗余序列
   - 生成代表性序列集用于后续比对

2. **基因组索引（Miniprot 索引）**
   - 为每个蜘蛛基因组建立 miniprot 索引
   - 加速后续的蛋白-基因组比对过程

3. **蛋白序列比对（Miniprot 比对）**
   - 将代表性 Spidroin 序列比对到蜘蛛基因组
   - 识别 N 端和 C 端结构域的位置
   - 生成 GFF 格式的比对结果

4. **基因边界确定**
   - 根据 N 端和 C 端的比对位置推断完整基因边界
   - 考虑链方向（正链/负链）的影响
   - 过滤低质量的比对结果

5. **结果整合与输出**
   - 按 Spidroin 类型分类整理预测结果
   - 合并所有类型生成初步的基因注释文件
   - 输出 GFF 和 CSV 格式的结果文件

### 输出结果
- 位置：`data/processed/01.miniprot_mapping/`
- 格式：GFF3 和 CSV
- **重要**：这是初步预测，需要人工审核和修正

### 使用方法
参见 [快速入门指南](getting-started.md)

---

## 人工修正（必需）

### 目标
审核和修正 Miniprot 初步注释的结果，提高基因预测的准确性。

### 操作步骤



1. **使用基因组浏览器审核**
   - 推荐工具：IGV、JBrowse、UCSC Genome Browser
   - 加载基因组序列和生成的 GFF 文件
   - 检查每个预测基因的合理性

> 如果数据量较小，则可以在 VScode 中打开 GFF 文件进行审核。

2. **修正常见问题**
   - 调整不准确的基因边界
   - 合并被错误分割的基因
   - 分割被错误融合的基因
   - 删除假阳性预测

3. **保存修正后的文件**
   - 建议保存为 `{species}.curated.gff`
   - 记录修正的原因和依据
   - 建立版本控制

### 输出结果
- 位置：`data/processed/02.manual_curation/`（建议）
- 格式：修正后的 GFF3 文件
- 附加：修正记录和说明文档

---

## 第二步A：整合三代 DRS 转录组数据（待实现）

### 目标
利用 Direct RNA Sequencing (DRS) 数据验证和精细化基因结构。

### 计划步骤

1. **DRS 数据比对**
   - 将 DRS 读段比对到基因组
   - 识别转录起始位点 (TSS) 和终止位点 (TTS)

2. **转录本结构验证**
   - 验证预测基因的转录本边界
   - 识别外显子-内含子结构

3. **可变剪接识别**
   - 检测同一基因的不同转录本变体
   - 注释主要和次要转录本

### 预期输出
- 位置：`data/processed/03.transcriptome_integration/`
- 格式：精细化的 GFF3 文件，包含转录本信息

---

## 第二步B：整合高质量基因组注释（待实现）

### 目标
利用高质量基因组组装的注释信息，交叉验证和完善基因位置。

### 计划步骤

1. **基因组注释比对**
   - 获取高质量基因组的注释结果（BRAKER、Augustus 等）
   - 与 Miniprot 预测结果进行比对

2. **交叉验证**
   - 识别两种方法都支持的基因
   - 标注高可信度区域

3. **完善基因结构**
   - 利用从头注释的外显子-内含子信息
   - 补充缺失的基因结构细节

### 预期输出
- 位置：`data/processed/04.genome_annotation_integration/`
- 格式：完善的 GFF3 文件，包含基因结构信息

---

## 第三步：多源数据汇总（待实现）

### 目标
整合 Miniprot、转录组和基因组注释的结果，生成高可信度的 Spidroin 基因集。

### 计划步骤

1. **证据整合**
   - 收集所有来源的证据
   - 建立证据等级体系

2. **冲突解决**
   - 处理不同来源的矛盾信息
   - 制定优先级规则

3. **质量评分**
   - 为每个基因预测分配可信度分数
   - 标注证据来源和数量

### 预期输出
- 位置：`data/processed/05.integrated_annotation/`
- 格式：高质量 Spidroin 基因集（GFF3 + 证据表格）

---

## 第四步：k-mer 特征扫描（待实现）

### 目标
从准确的全长 Spidroin 序列提取 k-mer 特征，全基因组扫描识别不完整基因。

### 计划步骤

1. **k-mer 特征提取**
   - 从高可信度的全长 Spidroin 序列提取特征性 k-mer
   - 建立 Spidroin 类型特异的 k-mer 库

2. **全基因组扫描**
   - 使用 k-mer 特征扫描整个基因组
   - 识别具有 Spidroin 特征但缺少完整结构的区域

3. **不完整基因识别**
   - 发现只有 N 端或只有 C 端的基因片段
   - 识别假基因和基因碎片
   - 补充前面步骤遗漏的基因

### 预期输出
- 位置：`data/processed/06.kmer_scan/`
- 格式：补充的基因预测（GFF3）+ k-mer 分布图

---

## 最终输出

完成所有步骤后，最终的 Spidroin 注释集将包括：

1. **高可信度基因集**
   - 有完整 N/C 端支持的基因
   - 有转录组和基因组注释支持的基因

2. **中等可信度基因集**
   - 只有部分证据支持的基因
   - 需要进一步验证的预测

3. **不完整基因集**
   - 基因片段和假基因
   - k-mer 扫描发现的候选区域

4. **注释报告**
   - 每个基因的证据来源
   - 可信度评分
   - 建议的后续验证方法

## 参考文档

- [快速入门指南](getting-started.md) - 如何运行第一步
- [技术细节](technical-details.md) - 算法和参数说明
- [数据格式](data-formats.md) - 输入输出文件格式
